name: Deploy live-arb worker to DO

on:
  push:
    branches:
      - main           # change if your production branch is different
    paths:
      - "workers/**"
      - "scripts/**"
      - "package.json"
      - "package-lock.json"
      - "tsconfig.json"
      - ".github/workflows/deploy-worker.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to DigitalOcean droplet over SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            cd /opt/algobet

            echo "[deploy] Pulling latest code..."
            git pull

            echo "[deploy] Installing dependencies..."
            npm ci --omit=dev || npm install --omit=dev

            echo "[deploy] Restarting PM2 worker..."
            pm2 restart live-arb-worker || pm2 start npm --name live-arb-worker -- run live-arb-worker

            pm2 save

            echo "[deploy] PM2 status:"
            pm2 status live-arb-worker
